<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expert Council Web App</title>
    <style>
        body { font-family: Arial, sans-serif; }
        #chat { width: 100%; height: calc(100vh - 100px); overflow-y: auto; }
        #input { width: 100%; height: 60px; position: fixed; bottom: 0; left: 0; box-sizing: border-box; }
    </style>
</head>
<body>
    <h1>Expert Council Web App</h1>
    <button onclick="startChat()">Start Chat</button>
    <button onclick="addExpert()">Add Expert</button>
    <button onclick="generateExperts()">Generate Experts</button>
    <a href="#" onclick="showActiveExperts()">Show Active Experts</a>
    <div id="chat"></div>
    <input type="text" id="input" placeholder="Type your message here" onkeydown="if(event.key === 'Enter') sendMessage()">
    <script>
        let experts = [];
        let history = [];
        let apiKey = '';

        function startChat() {
            document.getElementById('chat').innerHTML = '<p>Welcome to the Expert Council Simulation!</p>';
        }

        function showActiveExperts() {
            if (experts.length === 0) {
                alert("No active experts available.");
                return;
            }
            const expertList = experts.map(expert => `${expert.name} (Expertise: ${expert.expertise}, Personality: ${expert.personality})`).join('<br>');
            document.getElementById('chat').innerHTML += `<p><strong>Active Experts:</strong><br>${expertList}</p>`;
        }

        function addExpert() {
            const name = prompt("Enter a unique name for the expert:");
            const expertise = prompt("Enter the area of expertise:");
            const personality = prompt("Enter personality traits:");
            if (name && expertise && personality) {
                experts.push({ name, expertise, personality });
                alert(`Expert ${name} added successfully.`);
            } else {
                alert("All fields are required to add an expert.");
            }
        }

        function generateExperts() {
            const scenario = prompt("Describe the scenario for which you need experts:");
            if (!scenario) {
                alert("Scenario description is required.");
                return;
            }

            const promptText = `Generate a list of experts for the following scenario: ${scenario}. Format each expert as 'Name (Expertise: expertise, Personality: personality)'.`;

            fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [{ role: 'user', content: promptText }]
                })
            })
            .then(response => response.json())
            .then(data => {
                const expertList = data.choices[0].message.content.trim();
                expertList.split('\n').forEach(line => {
                    const match = line.match(/(.+) \(Expertise: (.+), Personality: (.+)\)/);
                    if (match) {
                        const [, name, expertise, personality] = match;
                        experts.push({ name, expertise, personality });
                    }
                });
                alert("Experts generated and added successfully.");
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error: Unable to generate experts.");
            });
        }

        window.onload = function() {
            apiKey = prompt("Please enter your API key:");
            if (!apiKey) {
                alert('API key is required to use this application.');
            }
        };

        function startChat() {
            apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter an API key.');
                return;
            }
            document.getElementById('chat').innerHTML = '<p>Welcome to the Expert Council Simulation!</p>';
        }

        function sendMessage() {
            const message = document.getElementById('input').value;
            if (!message) return;
            document.getElementById('chat').innerHTML += `<p>You: ${message}</p>`;
            history.push({ "Live Person": message });
            document.getElementById('input').value = '';
            promptExpertResponse();
        }

        function promptExpertResponse() {
            let choice = prompt("Who should reply? Options: A (All), N (None), or expert number.\n" +
                experts.map((expert, idx) => `${idx}: ${expert.name}`).join("\n"));
            choice = choice.trim().toUpperCase();
            if (choice === "A") {
                experts.forEach(expert => expertReply(expert));
            } else if (choice === "N") {
                return;
            } else {
                const expertIdx = parseInt(choice);
                if (!isNaN(expertIdx) && expertIdx >= 0 && expertIdx < experts.length) {
                    expertReply(experts[expertIdx]);
                } else {
                    alert("Invalid choice. Please try again.");
                }
            }
        }

        function expertReply(expert) {

            const expertDescriptions = experts.filter(exp => exp !== expert)
                .map(exp => `${exp.name}: Expertise in ${exp.expertise}, Personality: ${exp.personality}`)
                .join("\n");

            const messages = [
                {
                    role: "system",
                    content: `
                        You are ${expert.name}, an expert in ${expert.expertise} with a ${expert.personality} personality. 
                        Here are the other experts:\n${expertDescriptions}. \n\n 
                        Keep it conversational. Don't jump to conclusions and don't start with solutions. Minimize bullet points.
                        Do not answer for other experts. Only answer for yourself.
                        Don't focus on the points already made.
                        Focus on your unique strengths and experiences, don't try to give generic, well-rounded advice
                    `
                }
            ];

            let combinedUserMessage = "";
            history.forEach(entry => {
                const [role, message] = Object.entries(entry)[0];
                if (role === expert.name) {
                    if (combinedUserMessage) {
                        messages.push({ role: "user", content: combinedUserMessage.trim() });
                        combinedUserMessage = "";
                    }
                    messages.push({ role: "assistant", content: message });
                } else {
                    combinedUserMessage += `${role}: ${message} `;
                }
            });

            if (combinedUserMessage) {
                messages.push({ role: "user", content: combinedUserMessage.trim() });
            }

            fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [{ role: 'user', content: prompt }]
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    const responseText = data.choices[0].message.content.trim();
                    document.getElementById('chat').innerHTML += `<p>${expert.name}: ${responseText}</p>`;
                    history.push({ [expert.name]: responseText });
                } else {
                    console.error('Unexpected API response structure:', data);
                    document.getElementById('chat').innerHTML += `<p>Error: Unexpected API response structure.</p>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('chat').innerHTML += `<p>Error: Unable to fetch response from API.</p>`;
            });
        }
    </script>
</body>
</html>
